<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambient Draw - Canvas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://pixijs.download/release/pixi.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0A2342, #1C3A6B);
            color: white;
            overflow: hidden;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(6px);
        }
        .tool-panel {
            width: 120px;
            background: rgba(255, 255, 255, 0.12);
            padding: 15px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(6px);
            overflow-y: auto;
        }
        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .color-tile {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s;
        }
        .color-tile:hover {
            transform: scale(1.15);
        }
        .active-color {
            border-color: white;
        }
        .brush-settings {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .canvas-container {
            position: absolute;
            top: 60px;
            left: 120px;
            right: 0;
            bottom: 0;
            background: #0A2342;
        }

        /* Ключевое добавление: теперь холст поверх синего фона */
        #pixi-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
    </style>
</head>

<body>

    <!-- Верхняя панель -->
    <div class="top-bar">
        <button onclick="window.location.href='palette.html'" 
            style="padding: 8px 16px; background-color:#1C3A6B; border:none; border-radius:6px; color:white; cursor:pointer;">
            ← Back
        </button>

        <h2 style="margin:0; font-weight:300;">Ambient Draw — Canvas</h2>

        <div style="width:60px;"></div>
    </div>

    <!-- Левая панель с инструментами -->
    <div class="tool-panel">
        <h3 style="margin-top:0; font-weight:400;">Colors</h3>

        <div class="color-grid" id="colorGrid"></div>

        <div class="brush-settings">
            <h3 style="margin:0; font-weight:400;">Brush Size</h3>
            <input type="range" id="brushSize" min="2" max="80" value="20">

            <button id="brushBtn" style="padding:8px; background:#1C3A6B; color:white; border:none; border-radius:6px; cursor:pointer;">
                Brush
            </button>

            <button id="eraserBtn" style="padding:8px; background:#7A1C1C; color:white; border:none; border-radius:6px; cursor:pointer;">
                Eraser
            </button>
        </div>
    </div>

    <!-- Контейнер холста -->
    <div class="canvas-container">
        <canvas id="pixi-canvas"></canvas>
    </div>

    <script>
        // Чтение палитры из URL
        const params = new URLSearchParams(window.location.search);
        let paletteIndex = parseInt(params.get("palette")) || 0;

        // Наши три палитры по 21 цвету
        const palettes = [
            ["#1B263B","#415A77","#778DA9","#E0E1DD","#0D1B2A","#3E5C76","#748CAB","#F0F0F0","#A0A0A0","#C0C0C0","#E0E0E0","#102030","#203040","#304050","#506070","#708090","#90A0B0","#B0C0D0","#D0E0F0","#AABCCC","#8899BB"],
            ["#2E4057","#48639C","#4C769F","#679186","#BFB48F","#E5DCC8","#C9ADA7","#9A8C98","#4A4E69","#22223B","#6D6875","#7E6A9E","#9B6A6C","#C79D7C","#E2C290","#DAD2BC","#9C6644","#7E4E60","#586F7C","#2F4858","#33658A"],
            ["#F4D06F","#FF8811","#9DD9D2","#392F5A","#7EA8BE","#E28413","#F6AE2D","#F7D488","#A3D2CA","#5EAAA8","#056676","#A16AE8","#70D6FF","#FF70A6","#FF9770","#FFD670","#E9FF70","#C8F2E3","#90A955","#31572C","#132A13"]
        ];

        const colors = palettes[paletteIndex];

        // Создание цветовых плиток
        const colorGrid = document.getElementById("colorGrid");
        let currentColor = colors[0];

        colors.forEach(color => {
            const div = document.createElement("div");
            div.className = "color-tile";
            div.style.backgroundColor = color;
            div.onclick = () => selectColor(div, color);
            colorGrid.appendChild(div);
        });

        function selectColor(tile, color) {
            currentColor = color;
            document.querySelectorAll(".color-tile").forEach(t => t.classList.remove("active-color"));
            tile.classList.add("active-color");
        }

        // Выделяем первый цвет
        document.querySelector(".color-tile").classList.add("active-color");

        // PIXIJS — создаём приложение и холст
        const app = new PIXI.Application({
            view: document.getElementById("pixi-canvas"),
            resizeTo: document.querySelector(".canvas-container"),
            backgroundColor: 0x0A2342,
            antialias: true
        });

        const drawingLayer = new PIXI.Graphics();
        app.stage.addChild(drawingLayer);

        let drawing = false;
        let brushSize = 20;
        let eraserMode = false;

        const brushSizeSlider = document.getElementById("brushSize");
        brushSizeSlider.oninput = () => {
            brushSize = parseInt(brushSizeSlider.value);
        };

        document.getElementById("brushBtn").onclick = () => {
            eraserMode = false;
        };
        document.getElementById("eraserBtn").onclick = () => {
            eraserMode = true;
        };

        app.view.addEventListener("pointerdown", (e) => {
            drawing = true;
            draw(e);
        });

        app.view.addEventListener("pointerup", () => drawing = false);
        app.view.addEventListener("pointerupoutside", () => drawing = false);
        app.view.addEventListener("pointermove", draw);

        function draw(e) {
            if (!drawing) return;

            const pos = e.data ? e.data.global : app.renderer.plugins.interaction.mouse.global;

            if (eraserMode) {
                drawingLayer.beginFill(0x0A2342);
            } else {
                drawingLayer.beginFill(PIXI.utils.string2hex(currentColor));
            }
            drawingLayer.drawCircle(pos.x, pos.y, brushSize);
            drawingLayer.endFill();
        }
    </script>

</body>
</html>
