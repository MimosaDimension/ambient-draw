<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ambient Draw — Canvas</title>

  <!-- PixiJS -->
  <script src="https://pixijs.download/release/pixi.min.js"></script>

  <style>
    :root{
      --bg:#0f1724;
      --bg2:#051025;
      --accent:#7dd3fc;
      --text:#e6eef8;
      --subtext:#9fb1c9;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
    }
    .container{
      max-width:1200px;
      margin:20px auto;
      padding:16px;
      display:flex;
      gap:16px;
      align-items:flex-start;
    }

    /* left panel */
    .panel{
      width:180px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:12px;
      box-shadow:0 8px 20px rgba(2,6,23,0.5);
      box-sizing:border-box;
    }
    .panel h3{margin:6px 0 8px;font-size:15px}
    .palette-title{font-size:13px;color:var(--subtext);text-align:center;margin-bottom:8px}
    .palette-grid{display:grid;grid-template-columns:repeat(7,18px);grid-auto-rows:18px;gap:6px;justify-content:center;margin-bottom:12px}
    .sw{width:18px;height:18px;border-radius:3px;cursor:pointer;box-shadow:inset 0 1px 2px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;flex-direction:column;gap:8px}
    .btn{display:inline-block;padding:8px 10px;border-radius:8px;background:var(--accent);color:#012;font-weight:700;text-align:center;cursor:pointer;text-decoration:none;font-size:13px}
    .btn.ghost{background:transparent;color:var(--subtext);border:1px solid rgba(255,255,255,0.04)}
    .small{font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);text-align:center;cursor:pointer}
    .label{font-size:12px;color:var(--subtext);margin-bottom:6px}

    /* canvas area */
    .canvas-wrap{flex:1;display:flex;flex-direction:column;gap:10px}
    .canvas-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));border-radius:12px;padding:10px;box-shadow:0 8px 24px rgba(2,6,23,0.5)}
    #pixi-view{width:100%;height:640px;border-radius:8px;overflow:hidden;background:#0f1724;touch-action:none;position:relative}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .info{color:var(--subtext);font-size:13px}
    .status{font-size:13px;color:var(--subtext)}
    @media (max-width:900px){
      .container{flex-direction:column;padding:10px}
      .panel{width:100%;display:flex;flex-wrap:wrap;gap:8px}
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Left panel -->
    <div class="panel">
      <h3>Palette</h3>
      <div class="palette-title" id="paletteName">Ambient Set</div>
      <div class="palette-grid" id="paletteGrid"></div>

      <div style="height:8px"></div>

      <div class="label">Tool</div>
      <div style="display:flex;gap:8px;margin-bottom:6px">
        <div class="small" id="brushBtn">Brush</div>
        <div class="small" id="eraserBtn">Eraser</div>
      </div>

      <div>
        <div class="label">Brush size</div>
        <input id="sizeRange" type="range" min="2" max="80" value="18" style="width:100%"/>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <div class="btn" id="clearBtn">Clear</div>
        <div class="btn ghost" id="saveBtn">Save</div>
      </div>

      <div class="btn ghost" id="backBtn" style="display:block;margin-top:10px;text-align:center">← Back</div>
    </div>

    <!-- Canvas area -->
    <div class="canvas-wrap">
      <div class="canvas-card">
        <div class="topbar">
          <div class="info">Draw with colors — audio will be added later</div>
          <div class="status" id="status">Brush • Size 18</div>
        </div>

        <div id="pixi-view"></div>

        <div style="display:flex;justify-content:space-between;color:var(--subtext);font-size:13px">
          <div>Tip: use mouse, touch or pen (as mouse).</div>
          <div>Ambient Draw — prototype</div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

/* Palettes */
const PALETTES = {
  p1:{name:"Ambient Set 01", colors:[
      "#a6d8ff","#8bb3ff","#6a8bff","#5a92ff","#4a7eff","#3f6aff","#3460ff",
      "#8fffe2","#6cffc8","#4fe0aa","#36c98f","#22b377","#0e9f60","#007c4a",
      "#ffeaa6","#ffd88b","#ffc470","#ffb55a","#ffa440","#ff9330","#ff8220"
  ]},
  p2:{name:"Ambient Set 02", colors:[
      "#ffb3b3","#ff9999","#ff8080","#ff6666","#ff4d4d","#ff3333","#ff1a1a",
      "#ffd4a6","#ffbb88","#ffa270","#ff894d","#ff7033","#ff5720","#ff3d0d",
      "#fff1a6","#ffe788","#ffdd70","#ffd44d","#ffca33","#ffc220","#ffb700"
  ]},
  p3:{name:"Ambient Set 03", colors:[
      "#bfffc8","#90f0a4","#69d382","#42b460","#22a544","#009923","#007b19",
      "#c8eaff","#99dfff","#66d2ff","#33c6ff","#00b9ff","#0099cc","#007799",
      "#f0d4ff","#e6a6ff","#d97fff","#cc59ff","#bf33ff","#a800e6","#8f00bf"
  ]}
};

/* Read palette from URL */
function getParam(name){
  try{ return new URL(location.href).searchParams.get(name);}
  catch(e){return null;}
}
let paletteId = getParam('palette') || 'p1';
if(!PALETTES[paletteId]) paletteId='p1';

/* DOM references */
const paletteGrid = document.getElementById('paletteGrid');
const paletteName = document.getElementById('paletteName');
const statusEl = document.getElementById('status');
const brushBtn = document.getElementById('brushBtn');
const eraserBtn = document.getElementById('eraserBtn');
const sizeRange = document.getElementById('sizeRange');
const clearBtn = document.getElementById('clearBtn');
const saveBtn = document.getElementById('saveBtn');
const pixiView = document.getElementById('pixi-view');
const backBtn = document.getElementById('backBtn');

/* build palette UI */
function buildPalette(id){
  const pal = PALETTES[id];
  paletteName.textContent = pal.name;
  paletteGrid.innerHTML='';
  pal.colors.forEach((c,i)=>{
    const d=document.createElement('div');
    d.className='sw';
    d.style.background=c;
    d.dataset.color=c;
    d.title=c;
    d.addEventListener('click', ()=>{
      currentColor=c;
      currentTool='brush';
      updateUI();
      paletteGrid.querySelectorAll('.sw').forEach(x=>x.style.outline='0');
      d.style.outline='2px solid rgba(125,211,252,0.12)';
    });
    paletteGrid.appendChild(d);
    if(i===0) d.style.outline='2px solid rgba(125,211,252,0.12)';
  });
}
buildPalette(paletteId);

/* PIXIJS application */
const app = new PIXI.Application({
  backgroundAlpha: 0,
  antialias: true,
  autoDensity: true,
  resolution: Math.max(1,window.devicePixelRatio||1),
  resizeTo: pixiView
});
pixiView.appendChild(app.view);

/* drawing layer */
const g = new PIXI.Graphics();
app.stage.addChild(g);

/* state */
let drawing=false,last=null,currentColor=PALETTES[paletteId].colors[0];
let currentSize=parseInt(sizeRange.value,10)||18;
let currentTool='brush';

function updateUI(){
  statusEl.textContent=`${currentTool==='eraser'?'Eraser':'Brush'} • Size ${currentSize}`;
  brushBtn.style.background=currentTool==='brush'?'rgba(255,255,255,0.03)':'transparent';
  eraserBtn.style.background=currentTool==='eraser'?'rgba(255,255,255,0.03)':'transparent';
}
updateUI();

/* pointer helper */
function getPosFromEvent(e){
  const rect=app.view.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(app.renderer.width/rect.width)/app.renderer.resolution;
  const y=(e.clientY-rect.top)*(app.renderer.height/rect.height)/app.renderer.resolution;
  return {x,y};
}

/* draw line */
function drawLine(from,to,color,size,erase=false){
  if(erase){
    g.beginFill(0x0f1724);
    g.drawCircle(to.x,to.y,size);
    g.endFill();
    return;
  }
  g.lineStyle(size,PIXI.utils.string2hex(color),1,0.5,true);
  g.moveTo(from.x,from.y);
  g.lineTo(to.x,to.y);
  g.endFill();
}

/* pointer events */
app.view.addEventListener('pointerdown',e=>{
  drawing=true;
  last=getPosFromEvent(e);
  drawLine(last,last,currentColor,currentSize,currentTool==='eraser');
});
window.addEventListener('pointermove',e=>{
  if(!drawing) return;
  const pos=getPosFromEvent(e);
  drawLine(last,pos,currentColor,currentSize,currentTool==='eraser');
  last=pos;
});
window.addEventListener('pointerup',()=>{drawing=false; last=null;});
window.addEventListener('pointercancel',()=>{drawing=false; last=null;});

/* UI events */
brushBtn.addEventListener('click',()=>{currentTool='brush';updateUI();});
eraserBtn.addEventListener('click',()=>{currentTool='eraser';updateUI();});
sizeRange.addEventListener('input',()=>{currentSize=parseInt(sizeRange.value,10);updateUI();});
clearBtn.addEventListener('click',()=>{g.clear();});
saveBtn.addEventListener('click',()=>{
  const canvas=app.renderer.extract.canvas(app.stage);
  canvas.toBlob(blob=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='ambient-draw.png';
    a.click();
    URL.revokeObjectURL(a.href);
  },'image/png');
});

/* Back button */
backBtn.addEventListener('click',()=>{
  window.location.href='palettes.html';
});

updateUI();

}); // DOMContentLoaded end
</script>

</body>
</html>
